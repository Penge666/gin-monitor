## 监控指标制定

```go
type Metric struct {
	Type        MetricType
	Name        string
	Description string
	Labels      []string
	Buckets     []float64
	Objectives  map[float64]float64
	vec prometheus.Collector
}
```

为了适配了 Prometheus 的监控模型，因此，`Metric` 结构体需要相对应。

- `Type`：指标类型（Counter、Gauge、Histogram、Summary）。
- `Name`：指标名称，唯一标识。
- `Description`：指标的文字描述，方便阅读。
- `Labels`：标签，用于区分不同的维度。
- `Buckets`：Histogram 的桶范围，用于统计分布。
- `Objectives`：Summary 的目标百分位配置，用于计算 p50/p90/p99。
- `vec`：Prometheus 采集器，存储实际指标数据。

> **Type**

Prometheus 监控系统使用 **Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）和 Summary（摘要）** 四种指标类型，每种类型适用于不同的数据采集场景：

| 指标类型      | 作用         | 适用场景                 |
| ------------- | ------------ | ------------------------ |
| **Counter**   | 只能递增     | HTTP 请求总数、错误次数  |
| **Gauge**     | 可增可减     | 当前内存使用量、CPU 温度 |
| **Histogram** | 统计数据分布 | 请求延迟、响应时间       |
| **Summary**   | 计算百分位   | p95、p99 之类的响应时间  |

- **`Type`** 就是用于区分这些指标类型的。

> **Labels**

Prometheus 采用 **标签（Labels）** 作为核心查询方式，例如：

```promql
http_requests_total{method="GET", status="200"}
```

> **直方图 & 百分位分析**

在分析延迟（Latency）时，`Histogram` 和 `Summary` 是最常用的指标：

### 补充

>  **p50、p90、p95、p99 代表什么**

这些是 **百分位数（percentile）** 的缩写，表示一组数据中 **某个百分比的值**。它们主要用于衡量系统的 **响应时间（延迟）、请求处理时间** 等性能指标。

| 百分位            | 含义                                                         |
| ----------------- | ------------------------------------------------------------ |
| **p50（中位数）** | 50% 的请求延迟 **小于等于** 这个值（表示一半请求的延迟情况）。 |
| **p90**           | 90% 的请求延迟 **小于等于** 这个值（表示最慢 10% 请求的情况）。 |
| **p95**           | 95% 的请求延迟 **小于等于** 这个值（衡量系统性能波动）。     |
| **p99**           | 99% 的请求延迟 **小于等于** 这个值（查看最坏情况下的表现）。 |
| **p999（p99.9）** | 99.9% 的请求延迟 **小于等于** 这个值（检测极端延迟）。       |

**示例：请求延迟**

假设有 **10,000** 个 HTTP 请求，测量每个请求的响应时间（单位：毫秒 ms），并计算不同的百分位：

| 请求数     | 延迟 (ms) |
| ---------- | --------- |
| 1~5000     | 80 ms     |
| 5001~9000  | 120 ms    |
| 9001~9500  | 200 ms    |
| 9501~9900  | 350 ms    |
| 9901~9990  | 800 ms    |
| 9991~10000 | 2000 ms   |

计算不同百分位：

- **p50（50%）= 80ms**（一半请求延迟 ≤ 80ms）
- **p90（90%）= 200ms**（90% 的请求延迟 ≤ 200ms）
- **p95（95%）= 350ms**（95% 的请求延迟 ≤ 350ms）
- **p99（99%）= 800ms**（99% 的请求延迟 ≤ 800ms）
- **p999（99.9%）= 2000ms**（99.9% 的请求延迟 ≤ 2000ms）

**总结**

- **p50 = 中位数，一半请求的延迟低于这个值**。
- **p90/p95 = 代表大部分请求的响应时间（衡量系统稳定性）**。
- **p99 = 代表极端情况（尾部延迟），用于优化最慢的 1% 请求**。
- **p999 = 反映最差的 0.1% 请求，适用于金融/高并发业务**。

> **Buckets**

**`Buckets`：Histogram 的桶范围，用于统计分布**

在 Prometheus 中，`Histogram` 用于衡量一些量的 **分布情况**，例如请求延迟、响应时间等。通过设定不同的 **桶（Buckets）**，`Histogram` 能够将数据分成不同的范围进行统计，以便分析数据的分布情况。

**桶（Buckets）的作用**

`Buckets` 就是你设定的不同区间，用于将数据划分成多个类别（区间）。每个桶记录的是数据落在该范围内的数量。

**示例**

假设我们要统计 HTTP 请求的响应时间（单位：秒），并且希望知道大部分请求的响应时间大致分布。我们可以使用以下桶范围：

```go
Buckets: []float64{0.1, 0.5, 1.0, 2.0, 5.0}
```

这表示：

- 0.1 秒以下的请求会被计入第一个桶
- 0.1 秒到 0.5 秒之间的请求会被计入第二个桶
- 0.5 秒到 1.0 秒之间的请求会被计入第三个桶
- 1.0 秒到 2.0 秒之间的请求会被计入第四个桶
- 2.0 秒到 5.0 秒之间的请求会被计入第五个桶
- 超过 5.0 秒的请求会被计入“超出桶范围”的部分（这个不在 `Buckets` 中定义，但 Prometheus 会记录它）

## 开发思路

### 主要功能

1. **定义监控指标**：
   - 通过 `MetricType` 枚举定义了几种指标类型：`COUNTER`、`GAUGE`、`HISTOGRAM` 和 `SUMMARY`，这些类型分别用于不同的统计需求，例如请求次数、当前值、请求持续时间等。
2. **监控器 (`Monitor`) 结构体**：
   - `Monitor` 结构体用来存储监控配置信息，如：慢查询时间（`slowTime`）、监控路径（`metricPath`）、不需要监控的路径（`excludePath`）、请求延时统计阈值（`reqDuration`）、存储所有监控指标（`metrics`）等。
3. **Gin 中间件集成**：
   - `Monitor` 通过 `Use` 方法将监控集成到 Gin 路由中，`monitorInterceptor` 中间件会拦截 HTTP 请求，记录请求信息并在请求完成时处理监控指标。
4. **Prometheus 注册指标**：
   - 在 `initGinMetrics` 方法中，注册了多个监控指标到 Prometheus，包括请求总数、独立访问者总数、URI 请求总数、请求体总数、响应体总数、请求持续时间、慢请求总数等。
5. **指标处理函数**：
   - 使用 `promTypeHandler` 将不同类型的指标（如 `COUNTER`, `GAUGE` 等）注册到 Prometheus 中，每个类型有相应的处理函数（例如 `counterHandler`, `gaugeHandler` 等）。
6. **Metrics 查询与显示**：
   - Prometheus 的标准 `/metrics` 路径被暴露用于查询和显示监控数据，`promhttp.Handler().ServeHTTP()` 负责生成 Prometheus 格式的监控数据。

### 主要方法说明

- **`GetNewMonitor()`**：
  - 单例模式，确保只有一个 `Monitor` 实例，初始化并返回该实例。
- **`SetSlowTime()`、`SetMetricPath()`、`SetExcludePath()` 等**：
  - 设置监控器的一些配置选项，控制监控的细节，例如是否排除某些路径、请求持续时间统计的阈值等。
- **`AddMetric()`**：
  - 向 Prometheus 注册新的监控指标。每个指标都会通过相应的处理函数进行注册，并最终存储在 `metrics` 字典中。
- **`monitorInterceptor()`**：
  - 作为 Gin 中间件来拦截每个请求，记录其持续时间、响应信息等，并在请求结束后处理相关的监控数据。
- **`ginMetricHandle()`**：
  - 处理请求的监控数据，如请求总数、请求体大小、响应体大小、请求持续时间等，并将其记录到 Prometheus 中。

### 代码扩展

- **Bloom Filter**：
  - 代码中使用了一个布隆过滤器（`BloomFilter`），这是为了高效地检测是否已经访问过某些 URL，从而避免重复计数。
- **Prometheus 数据结构**：
  - 每个监控指标通过 `Metric` 结构体存储，并通过 `prometheus` 提供的 `Vec` 类型进行注册。这些指标可以根据不同的标签来分类统计数据。

**总结：**

首先，我先构建一个监控器，这个监控器维护着一些监控指标。开始创建监控器，接着在监控器中添加监控指标，以及对应的lable格式保存到Prometheus中，然后设置将monitor的拦截器添加到gin中，这样当每次请求打进服务器之后，解析请求更新prometheus里面的内容。我觉得主要就是构建设计label标签。